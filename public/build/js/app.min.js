//= ./app.module.js

/**
 * Created by krek on 01.08.17.
 */
angular
    .module('auth', []);

var app = angular
            .module('blog', ['ui.router', 'ngMessages', 'LocalStorageModule', 'ngMaterial', 'auth'])
            .run(function () {

            });
angular
    .module('blog')
    .config(function($stateProvider, $urlRouterProvider) {
        let mainState = {
                name: 'main',
                url: '/',
                component: 'blogList',
                resolve: {
                    items: function(BlogService) {
                        return BlogService.getAllPosts();
                    }
                }
            },
            auth = {
                name: 'auth',
                url: '/auth',
                component: 'auth',
            },
            blogState = {
                name: 'blog',
                url: '/blog/{itemId}',
                component: 'blogItem',
                resolve: {
                    post: function(BlogService, $transition$) {
                        console.log($transition$.params().itemId);
                        return BlogService.getPost($transition$.params().itemId);
                    }
                }
            },
            state404 = {
                name: '404',
                url: '/404',
                templateUrl: '/404.html'
            };


        $stateProvider.state(blogListState);
        $stateProvider.state(mainState);
        $stateProvider.state(blogState);
        $stateProvider.state(state404);
        $stateProvider.state(auth);

    })
angular
    .module('auth')

    .component('auth', {
        templateUrl: './js/app/auth/auth.tmpl.html',
        controller: authController,
    });

function authController($scope, authService, $state) {
    var $ctrl = this;

    $ctrl.$onInit = onInit;
    $ctrl.login = login;
    $ctrl.logout = logout;
    $ctrl.registration = registration;
    $ctrl.authMessage = '';
    $ctrl.regMessage = '';

    console.log($ctrl);

    function onInit() {
        "use strict";
        console.log(authService.status);
    }

    function login() {
        "use strict";
        var email = $ctrl.formData.authForm.email,
            password = $ctrl.formData.authForm.password;

        authService.authUser(email, password)
            .then(function() {
                $state.go('main');
            })
            .catch(function (err) {
                $ctrl.authMessage = err.data.message;
            });
    }

    function logout() {
        "use strict";
        authService.logout();
    }

    function registration() {
        "use strict";
        var email = $ctrl.formData.registrationForm.email,
            password = $ctrl.formData.registrationForm.password;

        console.log(authService.registerUser(email, password));
    }
}

/**
 * Created by krek on 08.08.17.
 */


angular
    .module('blog')

    .component('blogHeader', {
        templateUrl: './js/app/header/header.tmpl.html',
        controller: headerController
    });

function headerController($scope, authService) {
    let $ctrl = this;
    $ctrl.authService = authService;
    $ctrl.status = $ctrl.authService.status;
    $ctrl.email = $ctrl.status.authorization ? authService.getProfileData().email : '';

    $ctrl.logout = logout;


    $scope.$watch('$ctrl.status.authorization', checkAuth);

    function checkAuth(newValue, oldValue, scope) {
        "use strict";
        if (newValue) {
            $ctrl.email = authService.getProfileData().email;
        }
    }

    function logout () {
        "use strict";
        authService.logout();
    }
}


angular
    .module('auth')

    .service('authService', authService);


function authService($http, $q, $rootScope, localStorageService) {
    "use strict";
    var _self = this;

    _self.status = {
        authorization: isAuth(),
    };

    _self.registerUser = registerUser;
    _self.authUser = authUser;
    _self.logout = logout;

    _self.setProfileData = setProfileData;
    _self.getProfileData = getProfileData;
    _self.removeProfileData = removeProfileData;

    return _self;

    function isAuth() {
        return getProfileData() ? true : false;
    }

    function registerUser(email, password) {
        var deffered = $q.defer();
        $http
            .post("//localhost:3000/api/auth/signup", {
                email: email,
                password: password
            })
            .then(function (res) {
                deffered.resolve(authUser(email, password));

            }, function (err) {
                deffered.reject(err.status);
            });

        return deffered.promise;
    };

    function authUser(email, password) {
        "use strict";
        var deffered = $q.defer();
        $http
            .post("//localhost:3000/api/auth/signin", {
                email: email,
                password: password
            })
            .then(function (res) {
                var data = {
                    token: res.data.token,
                    email: res.config.data.email
                }
                setProfileData(data);
                _self.status.authorization = true;
                console.log(_self.status.authorization);
                deffered.resolve();
            }, function (err) {
                deffered.reject(err);
            });

        return deffered.promise;
    }

    function logout() {
        "use strict";
        $http
            .post("http://localhost:3000/api/auth/logout", {}, {
                headers: {
                    'Token': getProfileData().token
                }
            })
            .then(function (res) {
                    removeProfileData();
                    _self.status.authorization = false;
                },
                function (err) {
                    console.log(err);
                })
    }

    function setProfileData(data) {
        return localStorageService.set('blogData', data);
    }

    function getProfileData() {
        return localStorageService.get('blogData');
    }

    function removeProfileData() {
        return localStorageService.remove('blogData');
    }

}



angular
    .module('auth')
    .directive('checkEmail', function ($http, $q) {
        "use strict";
        return {
            require: 'ngModel',
            restrict: 'A',
            link: link
        }

        function link(scope, elem, attrs, ngModel) {
            ngModel.$asyncValidators.emailExist = emailExist;


            function emailExist(modelValue, viewValue) {
                return $http.get('//localhost:3000/api/auth/check/' + viewValue)
                    .then(function (response) {
                        if (response.data.status == 200) {
                            return true;
                        } else {
                            $q.reject(response.data.status);
                        }
                    });
            }
        }
    })
angular
    .module('auth')
    .directive('pwdCheck', function() {
        "use strict";
        return {
            require: 'ngModel',
            restrict: 'A',
            scope: {
                passwordValue: '=pwdCheck'
            },
            link: link
        }

        function link (scope, element, attrs, ngModel) {
            ngModel.$validators.pwdCheck = pwdCheck;
            scope.$watch('passwordValue', watch);

            function pwdCheck(modelValue) {
                return modelValue === scope.passwordValue;
            }


            function watch() {
                ngModel.$validate();
            }
        }

    })
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC5qcyIsImFwcC5tb2R1bGUuanMiLCJhcHAucm91dGVzLmpzIiwiYXV0aC9hdXRoLmNvbXBvbmVudC5qcyIsImJsb2ctbGlzdC9ibG9nLWxpc3QuY29tcG9uZW50LmpzIiwiYmxvZy1saXN0L2Jsb2ctbGlzdC50bXBsLmh0bWwuanMiLCJoZWFkZXIvaGVhZGVyLmNvbXBvbmVudC5qcyIsImF1dGgvc2VydmljZXMvYXV0aC5zZXJ2aWNlLmpzIiwiYXV0aC9kaXJlY3RpdmVzL2NoZWNrLWVtYWlsLmRpcmVjdGl2ZS5qcyIsImF1dGgvZGlyZWN0aXZlcy9wYXNzd29yZENoZWNrLmRpcmVjdGl2ZS5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTtBQUNBO0FDREE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ1ZBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FDMUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNwREE7QUFDQTtBQUNBO0FBQ0E7QUNIQTtBQ0FBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ2hDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUNyR0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQ3pCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSIsImZpbGUiOiJhcHAubWluLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy89IC4vYXBwLm1vZHVsZS5qc1xuIiwiLyoqXG4gKiBDcmVhdGVkIGJ5IGtyZWsgb24gMDEuMDguMTcuXG4gKi9cbmFuZ3VsYXJcbiAgICAubW9kdWxlKCdhdXRoJywgW10pO1xuXG52YXIgYXBwID0gYW5ndWxhclxuICAgICAgICAgICAgLm1vZHVsZSgnYmxvZycsIFsndWkucm91dGVyJywgJ25nTWVzc2FnZXMnLCAnTG9jYWxTdG9yYWdlTW9kdWxlJywgJ25nTWF0ZXJpYWwnLCAnYXV0aCddKVxuICAgICAgICAgICAgLnJ1bihmdW5jdGlvbiAoKSB7XG5cbiAgICAgICAgICAgIH0pOyIsImFuZ3VsYXJcbiAgICAubW9kdWxlKCdibG9nJylcbiAgICAuY29uZmlnKGZ1bmN0aW9uKCRzdGF0ZVByb3ZpZGVyLCAkdXJsUm91dGVyUHJvdmlkZXIpIHtcbiAgICAgICAgbGV0IG1haW5TdGF0ZSA9IHtcbiAgICAgICAgICAgICAgICBuYW1lOiAnbWFpbicsXG4gICAgICAgICAgICAgICAgdXJsOiAnLycsXG4gICAgICAgICAgICAgICAgY29tcG9uZW50OiAnYmxvZ0xpc3QnLFxuICAgICAgICAgICAgICAgIHJlc29sdmU6IHtcbiAgICAgICAgICAgICAgICAgICAgaXRlbXM6IGZ1bmN0aW9uKEJsb2dTZXJ2aWNlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gQmxvZ1NlcnZpY2UuZ2V0QWxsUG9zdHMoKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBhdXRoID0ge1xuICAgICAgICAgICAgICAgIG5hbWU6ICdhdXRoJyxcbiAgICAgICAgICAgICAgICB1cmw6ICcvYXV0aCcsXG4gICAgICAgICAgICAgICAgY29tcG9uZW50OiAnYXV0aCcsXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgYmxvZ1N0YXRlID0ge1xuICAgICAgICAgICAgICAgIG5hbWU6ICdibG9nJyxcbiAgICAgICAgICAgICAgICB1cmw6ICcvYmxvZy97aXRlbUlkfScsXG4gICAgICAgICAgICAgICAgY29tcG9uZW50OiAnYmxvZ0l0ZW0nLFxuICAgICAgICAgICAgICAgIHJlc29sdmU6IHtcbiAgICAgICAgICAgICAgICAgICAgcG9zdDogZnVuY3Rpb24oQmxvZ1NlcnZpY2UsICR0cmFuc2l0aW9uJCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJHRyYW5zaXRpb24kLnBhcmFtcygpLml0ZW1JZCk7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gQmxvZ1NlcnZpY2UuZ2V0UG9zdCgkdHJhbnNpdGlvbiQucGFyYW1zKCkuaXRlbUlkKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBzdGF0ZTQwNCA9IHtcbiAgICAgICAgICAgICAgICBuYW1lOiAnNDA0JyxcbiAgICAgICAgICAgICAgICB1cmw6ICcvNDA0JyxcbiAgICAgICAgICAgICAgICB0ZW1wbGF0ZVVybDogJy80MDQuaHRtbCdcbiAgICAgICAgICAgIH07XG5cblxuICAgICAgICAkc3RhdGVQcm92aWRlci5zdGF0ZShibG9nTGlzdFN0YXRlKTtcbiAgICAgICAgJHN0YXRlUHJvdmlkZXIuc3RhdGUobWFpblN0YXRlKTtcbiAgICAgICAgJHN0YXRlUHJvdmlkZXIuc3RhdGUoYmxvZ1N0YXRlKTtcbiAgICAgICAgJHN0YXRlUHJvdmlkZXIuc3RhdGUoc3RhdGU0MDQpO1xuICAgICAgICAkc3RhdGVQcm92aWRlci5zdGF0ZShhdXRoKTtcblxuICAgIH0pIiwiYW5ndWxhclxuICAgIC5tb2R1bGUoJ2F1dGgnKVxuXG4gICAgLmNvbXBvbmVudCgnYXV0aCcsIHtcbiAgICAgICAgdGVtcGxhdGVVcmw6ICcuL2pzL2FwcC9hdXRoL2F1dGgudG1wbC5odG1sJyxcbiAgICAgICAgY29udHJvbGxlcjogYXV0aENvbnRyb2xsZXIsXG4gICAgfSk7XG5cbmZ1bmN0aW9uIGF1dGhDb250cm9sbGVyKCRzY29wZSwgYXV0aFNlcnZpY2UsICRzdGF0ZSkge1xuICAgIHZhciAkY3RybCA9IHRoaXM7XG5cbiAgICAkY3RybC4kb25Jbml0ID0gb25Jbml0O1xuICAgICRjdHJsLmxvZ2luID0gbG9naW47XG4gICAgJGN0cmwubG9nb3V0ID0gbG9nb3V0O1xuICAgICRjdHJsLnJlZ2lzdHJhdGlvbiA9IHJlZ2lzdHJhdGlvbjtcbiAgICAkY3RybC5hdXRoTWVzc2FnZSA9ICcnO1xuICAgICRjdHJsLnJlZ01lc3NhZ2UgPSAnJztcblxuICAgIGNvbnNvbGUubG9nKCRjdHJsKTtcblxuICAgIGZ1bmN0aW9uIG9uSW5pdCgpIHtcbiAgICAgICAgXCJ1c2Ugc3RyaWN0XCI7XG4gICAgICAgIGNvbnNvbGUubG9nKGF1dGhTZXJ2aWNlLnN0YXR1cyk7XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gbG9naW4oKSB7XG4gICAgICAgIFwidXNlIHN0cmljdFwiO1xuICAgICAgICB2YXIgZW1haWwgPSAkY3RybC5mb3JtRGF0YS5hdXRoRm9ybS5lbWFpbCxcbiAgICAgICAgICAgIHBhc3N3b3JkID0gJGN0cmwuZm9ybURhdGEuYXV0aEZvcm0ucGFzc3dvcmQ7XG5cbiAgICAgICAgYXV0aFNlcnZpY2UuYXV0aFVzZXIoZW1haWwsIHBhc3N3b3JkKVxuICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgJHN0YXRlLmdvKCdtYWluJyk7XG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgLmNhdGNoKGZ1bmN0aW9uIChlcnIpIHtcbiAgICAgICAgICAgICAgICAkY3RybC5hdXRoTWVzc2FnZSA9IGVyci5kYXRhLm1lc3NhZ2U7XG4gICAgICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBmdW5jdGlvbiBsb2dvdXQoKSB7XG4gICAgICAgIFwidXNlIHN0cmljdFwiO1xuICAgICAgICBhdXRoU2VydmljZS5sb2dvdXQoKTtcbiAgICB9XG5cbiAgICBmdW5jdGlvbiByZWdpc3RyYXRpb24oKSB7XG4gICAgICAgIFwidXNlIHN0cmljdFwiO1xuICAgICAgICB2YXIgZW1haWwgPSAkY3RybC5mb3JtRGF0YS5yZWdpc3RyYXRpb25Gb3JtLmVtYWlsLFxuICAgICAgICAgICAgcGFzc3dvcmQgPSAkY3RybC5mb3JtRGF0YS5yZWdpc3RyYXRpb25Gb3JtLnBhc3N3b3JkO1xuXG4gICAgICAgIGNvbnNvbGUubG9nKGF1dGhTZXJ2aWNlLnJlZ2lzdGVyVXNlcihlbWFpbCwgcGFzc3dvcmQpKTtcbiAgICB9XG59XG4iLCIvKipcbiAqIENyZWF0ZWQgYnkga3JlayBvbiAwOC4wOC4xNy5cbiAqL1xuIiwiIiwiYW5ndWxhclxuICAgIC5tb2R1bGUoJ2Jsb2cnKVxuXG4gICAgLmNvbXBvbmVudCgnYmxvZ0hlYWRlcicsIHtcbiAgICAgICAgdGVtcGxhdGVVcmw6ICcuL2pzL2FwcC9oZWFkZXIvaGVhZGVyLnRtcGwuaHRtbCcsXG4gICAgICAgIGNvbnRyb2xsZXI6IGhlYWRlckNvbnRyb2xsZXJcbiAgICB9KTtcblxuZnVuY3Rpb24gaGVhZGVyQ29udHJvbGxlcigkc2NvcGUsIGF1dGhTZXJ2aWNlKSB7XG4gICAgbGV0ICRjdHJsID0gdGhpcztcbiAgICAkY3RybC5hdXRoU2VydmljZSA9IGF1dGhTZXJ2aWNlO1xuICAgICRjdHJsLnN0YXR1cyA9ICRjdHJsLmF1dGhTZXJ2aWNlLnN0YXR1cztcbiAgICAkY3RybC5lbWFpbCA9ICRjdHJsLnN0YXR1cy5hdXRob3JpemF0aW9uID8gYXV0aFNlcnZpY2UuZ2V0UHJvZmlsZURhdGEoKS5lbWFpbCA6ICcnO1xuXG4gICAgJGN0cmwubG9nb3V0ID0gbG9nb3V0O1xuXG5cbiAgICAkc2NvcGUuJHdhdGNoKCckY3RybC5zdGF0dXMuYXV0aG9yaXphdGlvbicsIGNoZWNrQXV0aCk7XG5cbiAgICBmdW5jdGlvbiBjaGVja0F1dGgobmV3VmFsdWUsIG9sZFZhbHVlLCBzY29wZSkge1xuICAgICAgICBcInVzZSBzdHJpY3RcIjtcbiAgICAgICAgaWYgKG5ld1ZhbHVlKSB7XG4gICAgICAgICAgICAkY3RybC5lbWFpbCA9IGF1dGhTZXJ2aWNlLmdldFByb2ZpbGVEYXRhKCkuZW1haWw7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBmdW5jdGlvbiBsb2dvdXQgKCkge1xuICAgICAgICBcInVzZSBzdHJpY3RcIjtcbiAgICAgICAgYXV0aFNlcnZpY2UubG9nb3V0KCk7XG4gICAgfVxufVxuXG4iLCJhbmd1bGFyXG4gICAgLm1vZHVsZSgnYXV0aCcpXG5cbiAgICAuc2VydmljZSgnYXV0aFNlcnZpY2UnLCBhdXRoU2VydmljZSk7XG5cblxuZnVuY3Rpb24gYXV0aFNlcnZpY2UoJGh0dHAsICRxLCAkcm9vdFNjb3BlLCBsb2NhbFN0b3JhZ2VTZXJ2aWNlKSB7XG4gICAgXCJ1c2Ugc3RyaWN0XCI7XG4gICAgdmFyIF9zZWxmID0gdGhpcztcblxuICAgIF9zZWxmLnN0YXR1cyA9IHtcbiAgICAgICAgYXV0aG9yaXphdGlvbjogaXNBdXRoKCksXG4gICAgfTtcblxuICAgIF9zZWxmLnJlZ2lzdGVyVXNlciA9IHJlZ2lzdGVyVXNlcjtcbiAgICBfc2VsZi5hdXRoVXNlciA9IGF1dGhVc2VyO1xuICAgIF9zZWxmLmxvZ291dCA9IGxvZ291dDtcblxuICAgIF9zZWxmLnNldFByb2ZpbGVEYXRhID0gc2V0UHJvZmlsZURhdGE7XG4gICAgX3NlbGYuZ2V0UHJvZmlsZURhdGEgPSBnZXRQcm9maWxlRGF0YTtcbiAgICBfc2VsZi5yZW1vdmVQcm9maWxlRGF0YSA9IHJlbW92ZVByb2ZpbGVEYXRhO1xuXG4gICAgcmV0dXJuIF9zZWxmO1xuXG4gICAgZnVuY3Rpb24gaXNBdXRoKCkge1xuICAgICAgICByZXR1cm4gZ2V0UHJvZmlsZURhdGEoKSA/IHRydWUgOiBmYWxzZTtcbiAgICB9XG5cbiAgICBmdW5jdGlvbiByZWdpc3RlclVzZXIoZW1haWwsIHBhc3N3b3JkKSB7XG4gICAgICAgIHZhciBkZWZmZXJlZCA9ICRxLmRlZmVyKCk7XG4gICAgICAgICRodHRwXG4gICAgICAgICAgICAucG9zdChcIi8vbG9jYWxob3N0OjMwMDAvYXBpL2F1dGgvc2lnbnVwXCIsIHtcbiAgICAgICAgICAgICAgICBlbWFpbDogZW1haWwsXG4gICAgICAgICAgICAgICAgcGFzc3dvcmQ6IHBhc3N3b3JkXG4gICAgICAgICAgICB9KVxuICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24gKHJlcykge1xuICAgICAgICAgICAgICAgIGRlZmZlcmVkLnJlc29sdmUoYXV0aFVzZXIoZW1haWwsIHBhc3N3b3JkKSk7XG5cbiAgICAgICAgICAgIH0sIGZ1bmN0aW9uIChlcnIpIHtcbiAgICAgICAgICAgICAgICBkZWZmZXJlZC5yZWplY3QoZXJyLnN0YXR1cyk7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gZGVmZmVyZWQucHJvbWlzZTtcbiAgICB9O1xuXG4gICAgZnVuY3Rpb24gYXV0aFVzZXIoZW1haWwsIHBhc3N3b3JkKSB7XG4gICAgICAgIFwidXNlIHN0cmljdFwiO1xuICAgICAgICB2YXIgZGVmZmVyZWQgPSAkcS5kZWZlcigpO1xuICAgICAgICAkaHR0cFxuICAgICAgICAgICAgLnBvc3QoXCIvL2xvY2FsaG9zdDozMDAwL2FwaS9hdXRoL3NpZ25pblwiLCB7XG4gICAgICAgICAgICAgICAgZW1haWw6IGVtYWlsLFxuICAgICAgICAgICAgICAgIHBhc3N3b3JkOiBwYXNzd29yZFxuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uIChyZXMpIHtcbiAgICAgICAgICAgICAgICB2YXIgZGF0YSA9IHtcbiAgICAgICAgICAgICAgICAgICAgdG9rZW46IHJlcy5kYXRhLnRva2VuLFxuICAgICAgICAgICAgICAgICAgICBlbWFpbDogcmVzLmNvbmZpZy5kYXRhLmVtYWlsXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHNldFByb2ZpbGVEYXRhKGRhdGEpO1xuICAgICAgICAgICAgICAgIF9zZWxmLnN0YXR1cy5hdXRob3JpemF0aW9uID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhfc2VsZi5zdGF0dXMuYXV0aG9yaXphdGlvbik7XG4gICAgICAgICAgICAgICAgZGVmZmVyZWQucmVzb2x2ZSgpO1xuICAgICAgICAgICAgfSwgZnVuY3Rpb24gKGVycikge1xuICAgICAgICAgICAgICAgIGRlZmZlcmVkLnJlamVjdChlcnIpO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIGRlZmZlcmVkLnByb21pc2U7XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gbG9nb3V0KCkge1xuICAgICAgICBcInVzZSBzdHJpY3RcIjtcbiAgICAgICAgJGh0dHBcbiAgICAgICAgICAgIC5wb3N0KFwiaHR0cDovL2xvY2FsaG9zdDozMDAwL2FwaS9hdXRoL2xvZ291dFwiLCB7fSwge1xuICAgICAgICAgICAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgICAgICAgICAgICAgJ1Rva2VuJzogZ2V0UHJvZmlsZURhdGEoKS50b2tlblxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAudGhlbihmdW5jdGlvbiAocmVzKSB7XG4gICAgICAgICAgICAgICAgICAgIHJlbW92ZVByb2ZpbGVEYXRhKCk7XG4gICAgICAgICAgICAgICAgICAgIF9zZWxmLnN0YXR1cy5hdXRob3JpemF0aW9uID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICBmdW5jdGlvbiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGVycik7XG4gICAgICAgICAgICAgICAgfSlcbiAgICB9XG5cbiAgICBmdW5jdGlvbiBzZXRQcm9maWxlRGF0YShkYXRhKSB7XG4gICAgICAgIHJldHVybiBsb2NhbFN0b3JhZ2VTZXJ2aWNlLnNldCgnYmxvZ0RhdGEnLCBkYXRhKTtcbiAgICB9XG5cbiAgICBmdW5jdGlvbiBnZXRQcm9maWxlRGF0YSgpIHtcbiAgICAgICAgcmV0dXJuIGxvY2FsU3RvcmFnZVNlcnZpY2UuZ2V0KCdibG9nRGF0YScpO1xuICAgIH1cblxuICAgIGZ1bmN0aW9uIHJlbW92ZVByb2ZpbGVEYXRhKCkge1xuICAgICAgICByZXR1cm4gbG9jYWxTdG9yYWdlU2VydmljZS5yZW1vdmUoJ2Jsb2dEYXRhJyk7XG4gICAgfVxuXG59XG5cblxuIiwiYW5ndWxhclxuICAgIC5tb2R1bGUoJ2F1dGgnKVxuICAgIC5kaXJlY3RpdmUoJ2NoZWNrRW1haWwnLCBmdW5jdGlvbiAoJGh0dHAsICRxKSB7XG4gICAgICAgIFwidXNlIHN0cmljdFwiO1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgcmVxdWlyZTogJ25nTW9kZWwnLFxuICAgICAgICAgICAgcmVzdHJpY3Q6ICdBJyxcbiAgICAgICAgICAgIGxpbms6IGxpbmtcbiAgICAgICAgfVxuXG4gICAgICAgIGZ1bmN0aW9uIGxpbmsoc2NvcGUsIGVsZW0sIGF0dHJzLCBuZ01vZGVsKSB7XG4gICAgICAgICAgICBuZ01vZGVsLiRhc3luY1ZhbGlkYXRvcnMuZW1haWxFeGlzdCA9IGVtYWlsRXhpc3Q7XG5cblxuICAgICAgICAgICAgZnVuY3Rpb24gZW1haWxFeGlzdChtb2RlbFZhbHVlLCB2aWV3VmFsdWUpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gJGh0dHAuZ2V0KCcvL2xvY2FsaG9zdDozMDAwL2FwaS9hdXRoL2NoZWNrLycgKyB2aWV3VmFsdWUpXG4gICAgICAgICAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uIChyZXNwb25zZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlc3BvbnNlLmRhdGEuc3RhdHVzID09IDIwMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcS5yZWplY3QocmVzcG9uc2UuZGF0YS5zdGF0dXMpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH0pIiwiYW5ndWxhclxuICAgIC5tb2R1bGUoJ2F1dGgnKVxuICAgIC5kaXJlY3RpdmUoJ3B3ZENoZWNrJywgZnVuY3Rpb24oKSB7XG4gICAgICAgIFwidXNlIHN0cmljdFwiO1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgcmVxdWlyZTogJ25nTW9kZWwnLFxuICAgICAgICAgICAgcmVzdHJpY3Q6ICdBJyxcbiAgICAgICAgICAgIHNjb3BlOiB7XG4gICAgICAgICAgICAgICAgcGFzc3dvcmRWYWx1ZTogJz1wd2RDaGVjaydcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBsaW5rOiBsaW5rXG4gICAgICAgIH1cblxuICAgICAgICBmdW5jdGlvbiBsaW5rIChzY29wZSwgZWxlbWVudCwgYXR0cnMsIG5nTW9kZWwpIHtcbiAgICAgICAgICAgIG5nTW9kZWwuJHZhbGlkYXRvcnMucHdkQ2hlY2sgPSBwd2RDaGVjaztcbiAgICAgICAgICAgIHNjb3BlLiR3YXRjaCgncGFzc3dvcmRWYWx1ZScsIHdhdGNoKTtcblxuICAgICAgICAgICAgZnVuY3Rpb24gcHdkQ2hlY2sobW9kZWxWYWx1ZSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBtb2RlbFZhbHVlID09PSBzY29wZS5wYXNzd29yZFZhbHVlO1xuICAgICAgICAgICAgfVxuXG5cbiAgICAgICAgICAgIGZ1bmN0aW9uIHdhdGNoKCkge1xuICAgICAgICAgICAgICAgIG5nTW9kZWwuJHZhbGlkYXRlKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgIH0pIl0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9
